
################
# {{{1 GENERAL
################

is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"

# Rebind prefix from 'C-b' to 'C-s'
unbind C-b
set -g prefix C-s
set -g mode-keys vi

# Reload config
bind e send-keys '$EDITOR ~/.tmux.conf && tmux source-file ~/.tmux.conf' Enter
bind r source-file ~/.tmux.conf \; display-message "Tmux config reloaded"
bind G source-file ~/.config/tmux/layouts/git_watch.tmux
bind M source-file ~/.config/tmux/layouts/monitor.tmux
bind Y source-file ~/.config/tmux/layouts/update.tmux
bind D send-keys 'kill -s USR1 $(tmux show-environment TMUX_PPID | sed ''s/^.*=//'') && tmux kill-session' Enter

set -g history-limit 50000                  # increase scrollback buffer size
set -g display-time 1500                    # tmux messages are displayed for 1.5 seconds
set -sg escape-time 0                       # no delay for escape key press
set -s default-terminal "screen-256color"   # upgrade $TERM
set -g focus-events on                      # focus events enabled for terminals that support them

setw -g aggressive-resize on                # resize to the smallest window in focus
setw -g monitor-activity on
set -g visual-activity on
set -g mouse on

# Rebind buffer to prefix+b
bind b choose-buffer #-Z

# When pressing prefix two times, send the second through tmux
bind C-s send-keys C-s

# Bind prefix+= to equalize panes (i.e. prefix+M-5)
bind -n M-= select-layout tiled

# Alt-[|] gets in copy mode and copy
bind -n M-[ copy-mode
bind -n M-] paste-buffer

# Mouse doesn't quit copy-mode
unbind -T copy-mode-vi MouseDragEnd1Pane

# Copy text to clipboard in copy-mode with Enter or Scroll whell click
bind -T copy-mode-vi MouseDown2Pane send-keys -X copy-pipe-no-clear "xclip -i -f -selection primary | xclip -i -selection clipboard"
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "xclip -i -f -selection primary | xclip -i -selection clipboard"

# Clear selection in copy-mode with C-l or right mouse click
bind -T copy-mode-vi C-l send-keys -X clear-selection
bind -T copy-mode-vi MouseDown3Pane send-keys -X clear-selection

# Escape to quit copy mode, even in vi-mode
bind -T copy-mode-vi Escape send-keys -X cancel

# Allow dim-ed colours, strike and italics in Tmux
set -sa terminal-overrides ',*:dim=\E[2m'
set -as terminal-overrides ',*:smxx=\E[9m'
set -as terminal-overrides ',*:sitm=\E[3m'

# Remote key-binding
bind -n F12 \
    set prefix None \; \
    set key-table off \; \
    refresh-client -S

bind -T off F12 \
    set -u prefix \; \
    set -u key-table \; \
    refresh-client -S

#################
# {{{1 PLUGINS
#################

set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins/'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'session-manager'

# Resurrect
set -g @resurrect-save 'S'
set -g @resurrect-restore 'R'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-dir '~/.cache/tmux/resurrect'

#################
# {{{1 WINDOWS
#################

# Right numbers for windows
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows
set -g renumber-windows on

# Change window name
set -g set-titles on
set -g set-titles-string '#h #S.#I'

# When renaming a window, set automatic-rename when empty name is given
bind , command-prompt -I "#W" "rename-window '%%' \; if-shell \"[ -z '#W' ]\" \"set automatic-rename on\""

# Shift-arrow to switch windows
bind -n S-Left previous-window
bind -n S-Right next-window

# Alt-[p|n] to switch windows
bind -n M-p previous-window
bind -n M-n next-window

# Alt+[1-8] to choose window
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8

# Alt-Shift-[p|n] to move windows
bind -n M-P swap-window -dt -1
bind -n M-N swap-window -dt +1

# Alt-[T|R] to create new window
bind -n M-T new-window
bind -n M-R new-window -c "#{pane_current_path}" -a

# Alt-Shift-W to kill window
bind -n M-W kill-window

###############
# {{{1 PANES
###############

# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind -n M-\\ split-window -h -c "#{pane_current_path}"
bind -n M-| split-window -h
bind -n C-M-\\ split-window -hf -c "#{pane_current_path}"

bind - split-window -v -c "#{pane_current_path}"
bind -n M-- split-window -v -c "#{pane_current_path}"
bind -n M-_ split-window -v
bind -n C-M-_ split-window -vf -c "#{pane_current_path}"
unbind '"'
unbind %

# Change layout with Alt+Shift+[1-5]
bind -n M-! select-layout main-horizontal
bind -n M-@ select-layout main-vertical
bind -n 'M-#' select-layout tiled
bind -n 'M-$' select-layout even-horizontal
bind -n M-% select-layout even-vertical

# Vim style pane selection
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim style pane resize
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

bind -n M-H resize-pane -L 2
bind -n M-J resize-pane -D 2
bind -n M-K resize-pane -U 2
bind -n M-L resize-pane -R 2

bind -r M-H resize-pane -L 1
bind -r M-J resize-pane -D 1
bind -r M-K resize-pane -U 1
bind -r M-L resize-pane -R 1

# Use Alt-vim keys without prefix key to switch panes
bind -n M-h if-shell "$is_vim" "send-keys M-h" "select-pane -L"
bind -n M-j if-shell "$is_vim" "send-keys M-j" "select-pane -D"
bind -n M-k if-shell "$is_vim" "send-keys M-k" "select-pane -U"
bind -n M-l if-shell "$is_vim" "send-keys M-l" "select-pane -R"

# Use Alt-arrow keys without prefix key to switch panes
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Alt+[<|>] to switch panes
bind -n M-< swap-pane -U
bind -n M-> swap-pane -D

# Prefix+u to join pane
bind u command-prompt -p "join pane from :" "join-pane -s ':%%'"

# Alt+z to zoom
bind -n M-z resize-pane -Z

# Alt-y to synchronize
bind -n M-y setw synchronize-panes

# Alt+w to kill pane
bind -n M-w kill-pane
bind o kill-pane -a

# Prefix+x to respawn
bind x respawn-pane -k -c "#{pane_current_path}"

# Define a custom command on M-g (several commands with ' ; ')
bind -n M-G command-prompt -p "Command:" \
    "set-buffer -b cmd '%%' \; \
    run 'mkdir -p ~/.cache/tmux' \; \
    save-buffer -b cmd ~/.cache/tmux/buffer_cmd \; \
    delete-buffer -b cmd \; \
    bind -n M-g source-file ~/.cache/tmux/buffer_cmd"

########################
# {{{1 DESIGN CHANGES
########################

# Panes
set -g pane-border-style bg=colour235,fg=colour238
set -g pane-active-border-style bg=colour236,fg=colour51

# Messages
set -g message-style bg=yellow,fg=black,bold
set -g message-command-style bg=black,fg=blue

# Loud or quiet?
set-option -g visual-activity off
set-option -g visual-bell off
set-option -g visual-silence off
set-window-option -g monitor-activity off
set-option -g bell-action none

# Modes
setw -g clock-mode-colour colour135
setw -g mode-style bg=colour238,fg=colour196,bold

# Statusbar
keys_off="#[fg=white,bg=colour088]#([ $(tmux show-option -qv key-table) = 'off' ] && echo 'OFF')#[default]"

set -g status-position bottom
set -g status-style bg=colour234,fg=colour137,dim
set -g status-left ' #[fg=colour39]#S '
set -g status-right " $keys_off #[fg=colour76,bold] %H:%M:%S #[fg=colour39,bold] %d %h "
set -g status-right-length 50
set -g status-left-length 20
set -g status-justify left
set -g status-interval 1

# Window status
setw -g window-status-current-style bg=colour238,fg=colour81,bold
setw -g window-status-current-format ' #I#[fg=colour250]:#[fg=colour255]#W#[fg=colour50]#F '

setw -g window-status-style bg=colour235,fg=colour138,none
setw -g window-status-format ' #I#[fg=colour237]:#[fg=colour250]#W#[fg=colour244]#F '

setw -g window-status-bell-style bg=colour1,fg=colour255,bold

#################
# {{{1 RUN TPM
#################

# Install tpm if needed
if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

# Run tpm
run '~/.config/tmux/plugins/tpm/tpm'

# vim:fdm=marker
